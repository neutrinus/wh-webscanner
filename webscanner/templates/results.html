{% extends "base.html" %}
{% load humanize %}

{% block title %}Webscan results for {{ test.domain }} {% endblock %}

{% block extrahead %} 
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-carousel.js"></script>


<link type="text/css" href="{{ STATIC_URL }}css/ui-lightness/jquery-ui-1.8.16.custom.css" rel="stylesheet" />   
<link type="text/css" href="{{ STATIC_URL }}css/jquery.jqplot.min.css" rel="stylesheet"/>

<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<!--[if lt IE 9]><script language="javascript" type="text/javascript" src="excanvas.js"></script><![endif]-->

<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}openlayers/OpenLayers.js"></script>

<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jquery.jqplot.min.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jqplot.pieRenderer.min.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jqplot.dateAxisRenderer.min.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jqplot.canvasTextRenderer.min.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jqplot.canvasAxisTickRenderer.min.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jqplot.categoryAxisRenderer.min.js"></script>

{% endblock %}




{% block content %}
<div class="page-header">
    <h1>SCAN Results for <a href="{{ test.url }}">{{ test.url }}</a></h1>
</div>



<div class="progress progress-striped active">
    <div class="bar" style="width: 10%;">10%</div>
</div>
   
<br />
    <div class="row-fluid">
        <div class="span12">
            <div class="row">
                <div class="span4">
                    <h3>Don't Wait</h3>
                    <p>Average website check takes 200 seconds. If your site is particularly slow it could be even more than 10 minutes. Pro-members just got .pdf report in their mailbox.</p>
                </div>
                <div class="span4">
                    <h3>Overall note</h3>
                    <br />
                    <p>basing on all checks bellow we give your website an overall note:</p>
                    <p style="font-size:4em; text-align:center"><span id="rating">?</span>/10<p>
                    <p id="congratulations" style="text-align:center; display:none;" >congratulations!</p>
                </div>
                <div class="span4">
                    <h3>The numbers!</h3>
                    <div id="chart" style="height:200px; width:290px;"></div>
                    <p>Scan time: <span id="timer">0</span> secs</p>
                </div>
            </div>
            
        </div>
    </div>

    
<hr />
    
    
<h2>Siteshots</h2>
<div id="myCarousel" class="carousel">
    <!-- Carousel items -->
    <div id="screenshots-inner" class="carousel-inner" style="height:400px">

    </div>
    <!-- Carousel nav -->
    <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
    <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
</div>
    
    

<div class="row">
    <h2>General</h2>
    
    <table class="table  table-bordered table-striped results" id="results_0"></table>
</div>

<div class="row">
    <h2>Performance</h2>
    <table class="table table-striped table-bordered results" id="results_5"></table>
</div>

<div class="row">
    <h2>Security</h2>
    <table class="table table-striped table-bordered results" id="results_3"></table>
</div>

<div class="row">
    <h2>SEO</h2>
    <table class="table table-striped table-bordered results" id="results_2"></table>
</div>


<div class="row">
    <h2>Mail</h2>
    <table class="table table-striped table-bordered results" id="results_1"></table>
</div>



<script type="text/javascript">
var finished = 0;
// miliseconds counter
var timer_val = 0; 
var statuses_ok = 0;
var statuses_error = 0;
var statuses_warning = 0;
var statuses_info = 0;
var rate_curr = 0;
var rate_max = 0;
var last_result = 0;

var s = 0;
$("#progressbar").progressbar({ value: 0 });
$("#screenshots").fadeOut();


function add_screenshot(status, output_desc, output_full, group) {
     $("#screenshots-inner")[0].innerHTML += output_full;
}

function add_result(status, output_desc, output_full, group, importance) {
    if (group == 4){
        add_screenshot(status, output_desc, output_full, group);
        return(0);
    }

    var element = document.createElement('tr');

    var a = document.createElement('td');
    a.setAttribute('class','output_desc');
    a.innerHTML = output_desc;
    element.appendChild(a);
    
    var a = document.createElement('td');
    a.setAttribute('class','status');
    
    rate_max += importance;
    
    if (status == 0) {
        element.setAttribute('class','status_ok');
        a.innerHTML += '<i class="icon-ok-sign"></i> '
        statuses_ok += 1;
        rate_curr += importance;
    } 
    if (status == 1) {
        element.setAttribute('class','status_error');
        a.innerHTML += '<img src="{{ STATIC_URL }}status_unsuccess.png" /> '
        statuses_error += 1;
        rate_curr += 0;
    }     
    if (status == 2) {
        element.setAttribute('class','status_warning');
        a.innerHTML += '<img src="{{ STATIC_URL }}status_warning.png" /> '
        statuses_warning += 1;
        rate_curr += (importance/4);
        }   
    if (status == 3) {
        element.setAttribute('class','status_info');
        a.innerHTML += '<i class="icon-info-sign"></i> '
        statuses_info += 1;
        rate_max -= importance;
        }  
    element.appendChild(a);

    status_plot.series[0].data = [ ['errors', statuses_error],['warnings', statuses_warning],['success', statuses_ok] ];
    status_plot.redraw()
    
    var a = document.createElement('td');
    a.setAttribute('class','output_full');
    a.innerHTML = output_full;
    element.appendChild(a);
    
    $("#results_"+group).append(element);   
    
    $(element).fadeOut(0);
    $(element).fadeIn("slow");
}

function check_progress(){
    $.ajax({
        url: "{% url scanner.views.scan_progress test.uuid %}",
        data: "",
        success: function(data) {
            $("#progressbar").progressbar({ value: (data.done/data.ordered)*100 });
            timer_val = (data.test_duration.toFixed(0) )*10
            $("#timer").text(timer_val/10)

            if (data.done/data.ordered != 1) {
                window.setTimeout(check_progress,1500);
            } else {
                $("#progressbar").fadeOut();
            }
        },
        error:function (xhr, ajaxOptions, thrownError){ console.log(xhr.status + thrownError);},
        dataType: "jsonp"
    });  
}
check_progress();

function check_results(){
    $.ajax({
        url: "{% url scanner.views.check_results test.uuid %}?last="+last_result,
        data: "",
        success: function(data) {
            $.each(data, function(key, value) { 
                if (value.id > last_result) last_result=value.id
                add_result(value.status, value.output_desc, value.output_full, value.group, value.importance)
            });
            if (finished == 0) window.setTimeout(check_results,1000);   
            if ($("#progressbar").progressbar("value") == 100) {
                finished = 1;

                $("#screenshots").fadeIn("slow");

                var rate = (Math.pow(rate_curr/rate_max,2))*10
                
                $("#rating").text( (rate).toFixed(1) );
                if (rate < 5 ) { $("#congratulations").text("Could be better..");}
                if ((rate >= 5 ) && (rate<7 )) { $("#congratulations").text("Not so bad.."); }
                if ((rate >= 7 ) && (rate<8.5 )) { $("#congratulations").text("Good!"); }
                if (rate >= 8.5 )  { $("#congratulations").text("Congratulations"); }
                $("#congratulations").fadeIn("slow");
            }
        },
        error:function (xhr, ajaxOptions, thrownError){ console.log(xhr.status + thrownError);},
        dataType: "jsonp"
    });  
}
check_results();   


function timer(){ 
    if (finished == 0){
            timer_val += 1
            $("#timer").text(timer_val/10)
            window.setTimeout(timer,100);   
        }
} 
timer() 

var data = [ ['errors', statuses_error],['warnings', statuses_warning], ['success', statuses_ok] ];
var status_plot = jQuery.jqplot ('chart', [data],
    {
    seriesDefaults: {
        // Make this a pie chart.
        renderer: jQuery.jqplot.PieRenderer,
        rendererOptions: {
            showDataLabels: true
        }
    },
    legend: {
          show:true,
          location: 'e',
    },
    grid: {
        background: 'transparent',
        borderWidth: '0',
        drawGridLines: false,
        shadow: false,
    },
    seriesColors: [ "#ffcccc", "#feffcc", "#ccffd1"],      
    });

    $('.carousel').carousel({
    interval: 2000
    })
    
</script>
    
    
{% endblock %}


